<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link type="text/css" rel="stylesheet" href="calendar-display.css">
    <!-- jquery -->
    <link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    
</head>

<body>
    <p>Login</p>
    <label for="username">Username: </label>
    <input type="text" id="username" name="username" placeholder="Username" required>
    <label for="current-password"></label>
    <input type="password" id="password" name="password" required>
    <button name="login-btn" id="login-btn"> Log In </button>
    <button name="logout-btn" id="logout-btn"> Log Out </button>

    <p>New User? Register</p>
    <label for="new-username">Username: </label>
    <input type="text" id="new-username" name="new-username" required>
    <label for="new-password"></label>
    <input type="password" id="new-password" name="new-password" required>
    <input type="button" name="create-user" id="create-user" value="Create Account">

    <div id="username">
        <p id="welcometext"></p>

    </div>

    <div id="monthyear">
        <p id="month"></p>
        <p id="year"></p>
    </div>
    <div id="buttons">
        <button id="prev-month-btn"> Previous Month </button>
        <button id="next-month-btn"> Next Month</button>
    </div>
    <table id="calendar">
        <tr>
            <th>Sun</th>
            <th>Mon</th>
            <th>Tues</th>
            <th>Wed</th>
            <th>Thurs</th>
            <th>Fri</th>
            <th>Sat</th>
        </tr>
        <tr class="week" id="week1">
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
        </tr>
        <tr class="week" id="week2">
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
        </tr>
        <tr class="week" id="week3">
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
        </tr>
        <tr class="week" id="week4">
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
        </tr>
        <tr class="week" id="week5">
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
        </tr>
        <tr class="week" id="week6">
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
            <td class="day">
                <p class="day-num"></p>
                <div class="class-events"></div>
            </td>
        </tr>
    </table>

    <div id="addEventForm">
    <label for="event-title">Event Title: </label>
    <input type="text" id="event-title" name="event-title">
    <label for="event-date">Event Date: </label>
    <input type="date" id="date" name="date">
    <label for="time">Event Time: </label>
    <input type="time" id="time" name="time">
    <input type='hidden' id="addToken" value="">
    <button id="add"> Add Event</button>
    </div>  
    <div id="event-details">
        <p id="event-description"></p>
        <label for="new-event-title">Event Title: </label>
        <input type="text" id="new-event-title" name="new-event-title">
        <label for="new-event-date">Event Date: </label>
        <input type="date" id="new-date" name="new-date">
        <label for="time">Event Time: </label>
        <input type="time" id="new-time" name="new-time">
        <button id="edit"> Edit Event</button>
        <button id="delete"> Delete Event</button>
    </div>

    <script>

        document.getElementById("create-user").addEventListener("click", createuserAjax, false);
        document.getElementById("login-btn").addEventListener("click", loginAjax, false);
        document.getElementById("add").addEventListener("click", addEvent, false);
        document.getElementById("logout-btn").addEventListener("click", logoutAjax, false);
      

        //add event to server
        function addEvent(event) {
            event.preventDefault();
            const title = document.getElementById("event-title").value;
            const time = document.getElementById("time").value;
            const date = document.getElementById("date").value;
            const addToken = document.getElementById("token1").value;
            // const token= document.getElementById("token1").value;
            console.log(addToken);
            const data = { 'title': title, 'date': date, 'time': time, 'token':token };
            fetch("addevent.php", {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'content-type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.loggedin == false) {
                        console.log(data.loggedin);
                        alert("You must be logged in.");
                    }
                    else {
                        updateCalendar();
                        alert(data.success ? "Event added" : `Event unable to be added:${data.message}`);
                        
                    }
                })
                // .then(response=>response.text())
                // .then(text=>console.log(text))
                .catch(err => console.error(err));
        }

        //log in
        let loginToken= "";
        function loginAjax(event) {
            const username = document.getElementById("username").value; // Get the username from the form
            const password = document.getElementById("password").value; // Get the password from the form
            // Make a URL-encoded string for passing POST data:
            const data = { 'username': username, 'password': password };
            fetch("login.php", {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'content-type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    //console.log(data);
                    console.log(data.success ? "You've been logged in!" : `You were not logged in ${data.message}`);
                    if (data.success == true) {
                        loginToken = data.token;
                        
                        // token1=document.createElement('input');
                        // token1.appendChild(document.createTextNode(data.token));
                        // token1.id="token1";
                        // token1.value=data.token;
                        // token1.setAttribute('type','hidden');
                        //document.getElementById("addToken").appendChild(data.token);

                        // token2=document.createElement('input');
                        // token2.appendChild(document.createTextNode(data.token));
                        // token2.id="token1";
                        // token2.setAttribute('type','hidden');
                        // document.getElementById("event-details").appendChild(token2);

                        alert("You've been successfully logged in!");
                        updateCalendar();
                    }
                    else {
                        alert("Incorrect Username or Password. Try again");
                    }
                })

                .catch(err => console.error(err));
            document.getElementById('username').value = "";
            document.getElementById('password').value = "";
            //set token
            document.getElementById('addToken').value=loginToken;

        }
        //log out
        function logoutAjax(event) {
            fetch("logout.php")
                .then(response => response.json())
                .then(data => {
                    if (data.success == true) {
                        // document.getElementById("token1").value=null;
                        // document.getElementById("token2").value=null;
                        alert("You've been successfully logged out!");
                        updateCalendar();
                    }
                    else {
                        alert("Try logging out again.");
                    }
                })
                .catch(err => console.error(err));
            updateCalendar();
        }
        //create user
        function createuserAjax(event) {
            event.preventDefault;
            const newUsername = document.getElementById("new-username").value; // Get the username from the form
            const newPassword = document.getElementById("new-password").value; // Get the password from the form
            // Make a URL-encoded string for passing POST data:
            const data = { 'new-username': newUsername, 'new-password': newPassword }
            fetch("createuser.php", {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'content-type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data.success ? "Your account has been created!" : `Your account was unable to be created: ${data.message}`);
                    if (data.exists == true) {
                        alert("This username already exists. Please choose another");
                    }
                    else if (data.invalid == true) {
                        alert("Invalid Characters. Please choose a username with alphanumeric characters only.")
                    }
                    else if (data.success == true) {
                        alert("Your account has been created!");
                    }
                    else {
                        alert("Your account was unable to be created. Please try again.");
                    }
                })
                .catch(err => console.error(err));
            document.getElementById('new-username').value = "";
            document.getElementById('new-password').value = "";
        }

        //calendar helper functions
        (function () {
            //returns a date object c days in the future
            Date.prototype.deltaDays = function (c) {
                return new Date(this.getFullYear(), this.getMonth(), this.getDate() + c)
            };
            //returns Sunday nearest in the past to this day
            Date.prototype.getSunday = function () {
                return this.deltaDays(-1 * this.getDay())
            }
        })();

        function Week(c) {
            this.sunday = c.getSunday();
            //returns a week object sequentially in the future
            this.nextWeek = function () {
                return new Week(this.sunday.deltaDays(7))
            };
            //returns a week object sequentially in the past
            this.prevWeek = function () {
                return new Week(this.sunday.deltaDays(-7))
            };
            //returns true if this week's sunday is the same as date's sunday; false otherwise
            this.contains = function (b) {
                return this.sunday.valueOf() === b.getSunday().valueOf()
            };
            //returns an Array containting 7 Date objects, each representing one of the seven days in this month
            this.getDates = function () {
                for (var b = [], a = 0; 7 > a; a++)
                    b.push(this.sunday.deltaDays(a));
                return b
            }
        }
        function Month(c, b) {
            //year associated with the month
            this.year = c;
            //month number (january = 0)
            this.month = b;
            //returns a month object sequentially in the future
            this.nextMonth = function () {
                return new Month(c + Math.floor((b + 1) / 12), (b + 1) % 12)
            };
            //returns a month object sequentially in the past
            this.prevMonth = function () {
                return new Month(c + Math.floor((b - 1) / 12), (b + 11) % 12)
            };
            //returns a date object representing the date d in the month
            this.getDateObject = function (a) {
                return new Date(this.year, this.month, a)
            };
            //returns an array containing all weeks spanned by the month; the weeks are represented as week objects
            this.getWeeks = function () {
                var a = this.getDateObject(1), b = this.nextMonth().getDateObject(0), c = [], a = new Week(a);
                for (c.push(a); !a.contains(b);)a = a.nextWeek(), c.push(a);
                return c
            }
        };

        // For our purposes, we can keep the current month in a variable in the global scope
        let currentMonth = new Month(2020, 9); // October 2020 (January = 0)

        //load calendar
        document.addEventListener("DOMContentLoaded", updateCalendar, false);
        // Change the month when the "next" button is pressed
        document.getElementById("next-month-btn").addEventListener("click", function (event) {
            currentMonth = currentMonth.nextMonth();
            updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
           // alert("The new month is " + currentMonth.month + " " + currentMonth.year);
        }, false);

        // Change the month when the "prev" button is pressed
        document.getElementById("prev-month-btn").addEventListener("click", function (event) {
            currentMonth = currentMonth.prevMonth();// Previous month would be currentMonth.prevMonth()
            updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
         //   alert("The new month is " + currentMonth.month + " " + currentMonth.year);
        }, false);


        //render calendar
        function updateCalendar() {
            let monthTitle = "";
            if (currentMonth.month == 0) {
                monthTitle = "January";
            } else if (currentMonth.month == 1) {
                monthTitle = "February";
            } else if (currentMonth.month == 2) {
                monthTitle = "March";
            } else if (currentMonth.month == 3) {
                monthTitle = "April";
            } else if (currentMonth.month == 4) {
                monthTitle = "May";
            } else if (currentMonth.month == 5) {
                monthTitle = "June";
            } else if (currentMonth.month == 6) {
                monthTitle = "July";
            } else if (currentMonth.month == 7) {
                monthTitle = "August";
            } else if (currentMonth.month == 8) {
                monthTitle = "September";
            } else if (currentMonth.month == 9) {
                monthTitle = "October";
            } else if (currentMonth.month == 10) {
                monthTitle = "November";
            } else if (currentMonth.month == 11) {
                monthTitle = "December";
            }

            document.getElementById("month").textContent = monthTitle;
            //currentMonth.month;
            document.getElementById("year").textContent = currentMonth.year;

            //clear calendar dates
            let date = document.getElementsByClassName("day-num");
            for (let d in date) {
                document.getElementsByClassName("day-num")[d].textContent = "";
            }

            let weeks = currentMonth.getWeeks();
            
            for (let w in weeks) {
                let days = weeks[w].getDates();
                // days contains normal JavaScript Date objects.
                // alert("Week starting on "+days[0]);
                for (let d in days) {
                    document.getElementsByClassName("week")[w].children[d].children[1].innerHTML = "";
                    document.getElementsByClassName("week")[w].children[d].firstElementChild.textContent = days[d].getDate();
                    document.getElementsByClassName("week")[w].children[d].id = days[d].toISOString().split('T')[0];

                }
            }
            //get events 
            fetch("getevents.php")
                .then(response => response.json())
                .then(data => {
                    if (data.logged != false) {
                        console.log('Success', JSON.stringify(data));
                        //console.log(data);
                        parseEvents(data);
                    }
                })
                //.then(response=>response.text())
                //.then(text=>console.log(text))
                .catch(err => console.error(err));

        }
        //parse out events based on database events
        function parseEvents(response) {


            let jsonData = JSON.parse(JSON.stringify(response));
            console.log(jsonData);
            let calendar_days = document.getElementsByClassName("day");
            for (let i = 0; i < calendar_days.length; i++) {
                let calendar_date = calendar_days[i].id;
                
                for (let n = 0; n < jsonData.length; n++) {
                    if (calendar_date == jsonData[n].date) {
                        let eventID = jsonData[n].event_id;
                        if (document.getElementById(eventID) == null) {
                            //create div to hold event
                            let event = document.createElement('div');
                            //show event title and event time
                            let eventText = document.createTextNode(jsonData[n].title + " at " + jsonData[n].time);
                            event.appendChild(eventText);
                            //set id of this div to the eventID
                            event.id = eventID;
                            //append this div to the div class events 
                            document.getElementById(calendar_date).children[1].appendChild(event);
                            //event.addEventListener("click", showdialog(event.id), false);
                            //show dialogue box
                            document.getElementById(calendar_date).children[1].addEventListener("click", showDialog, false);

                            //hidden token to events
                            let eventToken=document.createElement('input');
                            eventToken.appendChild(document.createTextNode(jsonData[n].token));
                            eventToken.className="token";
                            eventToken.setAttribute('type','hidden');
                            document.getElementById(calendar_date).children[1].appendChild(eventToken);

                        }

                    }
                }
            }
        }

        function showDialog(event) { 
            let eventid = event.target.id; //use to access the specific event in mysql
            $("#event-details").dialog();

            document.getElementById("edit").addEventListener("click",editEvent, false);
            document.getElementById("delete").addEventListener("click",deleteEvent,false);

            //edit event 
            function editEvent(event){
                event.preventDefault();
                const ntitle = document.getElementById("new-event-title").value;
                const ntime = document.getElementById("new-time").value;
                const ndate = document.getElementById("new-date").value;
                const token = document.getElementsByClassName("token")[0].value;
                const data = { 'new-event-title': ntitle, 'new-date': ndate, 'new-time': ntime, 'eventid':eventid, 'token':token };
                fetch('editevent.php', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'content-type': 'application/json' }
                })
                .then(response=>response.json())
               // .then(response=>response.text())
              //  .then(text=>console.log(text))
                 .then(data=> {
                     updateCalendar();
                     alert(data.success ? "Event changed" : `Could not be edited: ${ndata.message}`);
                     })
                
                .catch(err => console.error(err));
                $("#event-details").dialog('close');
            }

            function deleteEvent(event){
                event.preventDefault();
                const data={'eventid':eventid};
                fetch('deleteevent.php', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'content-type': 'application/json' }
                })
                .then(response=>response.json())
                .then(data=> {
                     updateCalendar();
                     alert(data.success ? "Event deleted" : `Could not be deleted: ${data.message}`);
                     })
                .catch(err => console.error(err));
                $("#event-details").dialog('close');

            }
        }



    </script>
</body>

</html>