<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link type="text/css" rel="stylesheet" href="calendar-display.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <p>Login</p>
    <label for="username">Username: </label>
    <input type="text" id="username" name="username" placeholder="Username" required>
    <label for="current-password"></label>
    <input type="password" id="password" name="password" required>
    <button name="login-btn" id="login-btn"> Log In </button> 
    <button name="logout-btn" id="logout-btn"> Log Out </button>

    <p>New User? Register</p>
    <label for="new-username">Username: </label>
    <input type="text" id="new-username" name="new-username" required>
    <label for="new-password"></label>
    <input type="password" id="new-password" name="new-password" required>
    <input type="button" name="create-user" id="create-user" value="Create Account">
    
    <div id="monthyear">
        <p id="month"></p>
        <p id="year"></p>
    </div>
    <div id="buttons">
        <button id="prev-month-btn"> Previous Month </button>
        <button id="next-month-btn"> Next Month</button>
    </div>
    <table id="calendar">
        <tr>
            <th>Sun</th>
            <th>Mon</th>
            <th>Tues</th>
            <th>Wed</th>
            <th>Thurs</th>
            <th>Fri</th>
            <th>Sat</th>
        </tr>
        <tr class="week" id="week1">
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
        </tr>
        <tr class="week" id="week2">
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
        </tr>
        <tr class="week" id="week3">
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
        </tr>
        <tr class="week" id="week4">
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
        </tr>
        <tr class="week" id="week5">
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
        </tr>
        <tr class="week" id="week6">
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
            <td class="day"> <p class="day-num"></p> <div class="class-events"></div></td>
        </tr>
    </table> 

    <label for="event-title">Event Title: </label>
    <input type="text" id="event-title" name="event-title" required> 
    <label for="event-date">Event Date: </label>
    <input type="date" id="date" name="date" required>
    <label for="time">Event Time: </label>
    <input type="time" id="time" name="time" required>
    <button id="add"> Add Event</button>  

    <script>
        
        document.getElementById("create-user").addEventListener("click", createuserAjax, false);
        document.getElementById("login-btn").addEventListener("click", loginAjax, false); 
        document.getElementById("add").addEventListener("click",addEvent,false );
        document.getElementById("add").addEventListener("click", updateCalendar, false);
        document.getElementById("logout-btn").addEventListener("click", logoutAjax, false);
        //add event to server
        function addEvent(event){
            event.preventDefault();
            const title=document.getElementById("event-title").value;
            const time=document.getElementById("time").value;
            const date=document.getElementById("date").value;
            const data={'title': title, 'date':date, 'time':time};
            fetch("addevent.php",{
                method:'POST',
                body:JSON.stringify(data),
                headers: { 'content-type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if(data.loggedin==false){
                    console.log(data.loggedin);
                    alert("You must be logged in.");
                    }
                    else{
                    console.log(data.success ? "Event added":`Event unable to be added:${data.message}`);
                    }
                })
                
                .catch(err => console.error(err));
        }
        
    
        //log in
        function loginAjax(event) {
            const username = document.getElementById("username").value; // Get the username from the form
            const password = document.getElementById("password").value; // Get the password from the form
            // Make a URL-encoded string for passing POST data:
            const data = { 'username': username, 'password': password };
            fetch("login.php", {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'content-type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data.success ? "You've been logged in!" : `You were not logged in ${data.message}`);
                    if(data.success==true){
                        alert("You've been successfully logged in!");
                        updateCalendar();
                    }
                    else{
                       alert("Incorrect Username or Password. Try again");
                    }
                })

                .catch(err => console.error(err));
                document.getElementById('username').value = "";
                document.getElementById('password').value = ""; 
                
            }
        //log out
        function logoutAjax(event){
            fetch("logout.php")
                .then(response=>response.json())
                .then(data=>{
                    if (data.success==true){
                        alert("You've been successfully logged out!");
                        updateCalendar();
                    }
                    else{
                        alert("Try logging out again.");
                    }
                })
                .catch(err => console.error(err));
                updateCalendar();
        }
        //create user
        function createuserAjax(event) {
            event.preventDefault;
            const newUsername = document.getElementById("new-username").value; // Get the username from the form
            const newPassword = document.getElementById("new-password").value; // Get the password from the form
            // Make a URL-encoded string for passing POST data:
            const data = {'new-username': newUsername, 'new-password': newPassword}
            fetch("createuser.php", {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'content-type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {console.log(data.success ? "Your account has been created!" : `Your account was unable to be created: ${data.message}`);
                    if(data.exists==true){
                        alert("This username already exists. Please choose another");
                    }
                    else if(data.invalid==true){
                        alert("Invalid Characters. Please choose a username with alphanumeric characters only.")
                    }
                    else if(data.success==true){
                        alert ("Your account has been created!");
                    }
                    else{
                        alert ("Your account was unable to be created. Please try again.");
                    }
                })
                .catch(err => console.error(err));
                document.getElementById('new-username').value = "";
                document.getElementById('new-password').value = ""; 


        }
        
        //calendar helper functions
        (function(){
            //returns a date object c days in the future
            Date.prototype.deltaDays=function(c){
                return new Date(this.getFullYear(),this.getMonth(),this.getDate()+c)
                };
            //returns Sunday nearest in the past to this day
            Date.prototype.getSunday=function(){
                    return this.deltaDays(-1*this.getDay())
                }
            })();

        function Week(c){
            this.sunday=c.getSunday();
            //returns a week object sequentially in the future
            this.nextWeek=function(){
                return new Week(this.sunday.deltaDays(7))
                };
            //returns a week object sequentially in the past
            this.prevWeek=function(){
                return new Week(this.sunday.deltaDays(-7))
                };
            //returns true if this week's sunday is the same as date's sunday; false otherwise
            this.contains=function(b){
                return this.sunday.valueOf()===b.getSunday().valueOf()
                };
            //returns an Array containting 7 Date objects, each representing one of the seven days in this month
            this.getDates=function(){
                for(var b=[],a=0;7>a;a++)
                b.push(this.sunday.deltaDays(a));
                return b
                }
            }
        function Month(c,b){
            //year associated with the month
            this.year=c;
            //month number (january = 0)
            this.month=b;
            //returns a month object sequentially in the future
            this.nextMonth=function(){
                return new Month(c+Math.floor((b+1)/12),(b+1)%12)
                };
            //returns a month object sequentially in the past
            this.prevMonth=function(){
                return new Month(c+Math.floor((b-1)/12),(b+11)%12)
                };
            //returns a date object representing the date d in the month
            this.getDateObject=function(a){
                return new Date(this.year,this.month,a)
                };
            //returns an array containing all weeks spanned by the month; the weeks are represented as week objects
            this.getWeeks=function(){
                var a=this.getDateObject(1),b=this.nextMonth().getDateObject(0),c=[],a=new Week(a);
                for(c.push(a);!a.contains(b);)a=a.nextWeek(),c.push(a);
                return c
                }
            };

        // For our purposes, we can keep the current month in a variable in the global scope
        let currentMonth = new Month(2020, 9); // October 2020 (January = 0)
        
        //load calendar
        document.addEventListener("DOMContentLoaded", updateCalendar, false);
        // Change the month when the "next" button is pressed
        document.getElementById("next-month-btn").addEventListener("click", function(event){
            currentMonth = currentMonth.nextMonth();
            updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
            alert("The new month is "+currentMonth.month+" "+currentMonth.year);
        }, false);

        // Change the month when the "prev" button is pressed
        document.getElementById("prev-month-btn").addEventListener("click", function(event){
            currentMonth = currentMonth.prevMonth();// Previous month would be currentMonth.prevMonth()
            updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
            alert("The new month is "+currentMonth.month+" "+currentMonth.year);
        }, false);

       
        //render calendar
        function updateCalendar(){
            let monthTitle = "";
            if (currentMonth.month == 0) {
                monthTitle = "January";
            } else if (currentMonth.month == 1){
                monthTitle = "February";
            } else if (currentMonth.month == 2){
                monthTitle = "March";
            } else if (currentMonth.month == 3){
                monthTitle = "April";
            } else if (currentMonth.month == 4){
                monthTitle = "May";
            } else if (currentMonth.month == 5){
                monthTitle = "June";
            } else if (currentMonth.month == 6){
                monthTitle = "July";
            } else if (currentMonth.month == 7){
                monthTitle = "August";
            } else if (currentMonth.month == 8){
                monthTitle = "September";
            } else if (currentMonth.month == 9){
                monthTitle = "October";
            } else if (currentMonth.month == 10){
                monthTitle = "November";
            } else if (currentMonth.month == 11){
                monthTitle = "December";
            }
            
            document.getElementById("month").textContent=monthTitle;
            //currentMonth.month;
            document.getElementById("year").textContent=currentMonth.year;
            let weeks = currentMonth.getWeeks();
            console.log(weeks);
            for(let w in weeks){
                let days = weeks[w].getDates();
                // days contains normal JavaScript Date objects.
               // alert("Week starting on "+days[0]);
                for(let d in days){
                    document.getElementsByClassName("week")[w].children[d].children[1].innerHTML="";
                    document.getElementsByClassName("week")[w].children[d].firstElementChild.textContent=days[d].getDate();
                    document.getElementsByClassName("week")[w].children[d].id=days[d].toISOString().split('T')[0];
                    

                }
            }
            //get events 
            fetch("getevents.php")
                .then(response => response.json())
                .then(data => {
                    if(data.logged!=false){
                        console.log('Success', JSON.stringify(data));
                        parseEvents(data);
                    }
                })
                //.then(response=>response.text())
                //.then(text=>console.log(text))
                .catch(err => console.error(err));
                
        }
        //parse out events based on database events
        function parseEvents(response){
                let jsonData=JSON.parse(JSON.stringify(response));
                console.log(jsonData.length);
                let calendar_days=document.getElementsByClassName("day");
                for(let i=0;i<calendar_days.length;i++){
                    let calendar_date=calendar_days[i].id;
                    console.log(calendar_date);
                    for(let n=0;n<jsonData.length;n++){
                        if(calendar_date==jsonData[n].date){
                            let eventID=jsonData[n].event_id;
                            if(document.getElementById(eventID)==null){
                                let event=document.createElement('div');
                                let eventText=document.createTextNode(jsonData[n].title + " at " + jsonData[n].time);
                                event.appendChild(eventText);
                                event.id=eventID;
                                document.getElementById(calendar_date).children[1].appendChild(event);
                            }
                            
                        }
                    }
                }
            }
        
        
    </script>
</body>
</html>