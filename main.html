<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link type="text/css" rel="stylesheet" href="calendar-display.css">

</head>
<body>
    <p>Login</p>
    <label for="username">Username: </label>
    <input type="text" id="username" name="username" placeholder="Username">
    <label for="current-password"></label>
    <input type="password" id="password" name="password">
    <button name="login-btn" id="login-btn"> Log In </button> 


    <p>New User? Register</p>
    <label for="new-username">Username: </label>
    <input type="text" id="new-username" name="new-username">
    <label for="new-password"></label>
    <input type="password" id="new-password" name="new-password">
    <input type="submit" name="create-user" id="create-user" value="Create Account">
    
    <div id="monthyear">
        <p id="month"></p>
        <p id="year"></p>
    </div>
    <div id="buttons">
        <button id="prev-month-btn"> Previous Month </button>
        <button id="next-month-btn"> Next Month</button>
    </div>
    <table id="calendar">
        <tr>
            <th>Sun</th>
            <th>Mon</th>
            <th>Tues</th>
            <th>Wed</th>
            <th>Thurs</th>
            <th>Fri</th>
            <th>Sat</th>
        </tr>
        <tr class="week" id="week1">
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
        </tr>
        <tr class="week" id="week2">
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
        </tr>
        <tr class="week" id="week3">
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
        </tr>
        <tr class="week" id="week4">
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
        </tr>
        <tr class="week" id="week5">
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
            <td class="day"></td>
        </tr>
    </table>    
    <script>
        
        document.getElementById("create-user").addEventListener("click", createuserAjax, false);
        document.getElementById("login-btn").addEventListener("click", loginAjax, false); // Bind the AJAX call to button click

        function loginAjax(event) {
            event.preventDefault();
            const username = document.getElementById("username").value; // Get the username from the form
            const password = document.getElementById("password").value; // Get the password from the form
            // Make a URL-encoded string for passing POST data:
            const data = { 'username': username, 'password': password };
            fetch("login.php", {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'content-type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data.success ? "You've been logged in!" : `You were not logged in ${data.message}`);
                    if(data.success==true){
                        alert("You've been successfully logged in!");
                    }
                    else{
                       alert("Incorrect Username or Password. Try again");
                    }
                })

                .catch(err => console.error(err));
            }

        function createuserAjax(event) {
            event.preventDefault;
            const newUsername = document.getElementById("new-username").value; // Get the username from the form
            const newPassword = document.getElementById("new-password").value; // Get the password from the form
            // Make a URL-encoded string for passing POST data:
            const data = {'new-username': newUsername, 'new-password': newPassword}
            fetch("createuser.php", {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'content-type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {console.log(data.success ? "Your account has been created!" : `Your account was unable to be created: ${data.message}`);
                    if(data.invalid==true){
                        alert("Invalid Characters. Please choose a username with alphanumeric characters only.")
                    }
                    else if(data.success==true){
                        alert ("Your account has been created!");
                    }
                    else{
                        alert ("Your account was unable to be created. Please try again.");
                    }
                })
                .catch(err => console.error(err));

        }

        (function(){
            //returns a date object c days in the future
            Date.prototype.deltaDays=function(c){
                return new Date(this.getFullYear(),this.getMonth(),this.getDate()+c)
                };
            //returns Sunday nearest in the past to this day
            Date.prototype.getSunday=function(){
                    return this.deltaDays(-1*this.getDay())
                }
            })();

        function Week(c){
            this.sunday=c.getSunday();
            //returns a week object sequentially in the future
            this.nextWeek=function(){
                return new Week(this.sunday.deltaDays(7))
                };
            //returns a week object sequentially in the past
            this.prevWeek=function(){
                return new Week(this.sunday.deltaDays(-7))
                };
            //returns true if this week's sunday is the same as date's sunday; false otherwise
            this.contains=function(b){
                return this.sunday.valueOf()===b.getSunday().valueOf()
                };
            //returns an Array containting 7 Date objects, each representing one of the seven days in this month
            this.getDates=function(){
                for(var b=[],a=0;7>a;a++)
                b.push(this.sunday.deltaDays(a));
                return b
                }
            }
        function Month(c,b){
            //year associated with the month
            this.year=c;
            //month number (january = 0)
            this.month=b;
            //returns a month object sequentially in the future
            this.nextMonth=function(){
                return new Month(c+Math.floor((b+1)/12),(b+1)%12)
                };
            //returns a month object sequentially in the past
            this.prevMonth=function(){
                return new Month(c+Math.floor((b-1)/12),(b+11)%12)
                };
            //returns a date object representing the date d in the month
            this.getDateObject=function(a){
                return new Date(this.year,this.month,a)
                };
            //returns an array containing all weeks spanned by the month; the weeks are represented as week objects
            this.getWeeks=function(){
                var a=this.getDateObject(1),b=this.nextMonth().getDateObject(0),c=[],a=new Week(a);
                for(c.push(a);!a.contains(b);)a=a.nextWeek(),c.push(a);
                return c
                }
            };

        // For our purposes, we can keep the current month in a variable in the global scope
        let currentMonth = new Month(2020, 9); // October 2020 (January = 0)
        
        //load calendar
        document.addEventListener("DOMContentLoaded", updateCalendar, false);
        // Change the month when the "next" button is pressed
        document.getElementById("next-month-btn").addEventListener("click", function(event){
            currentMonth = currentMonth.nextMonth(); // Previous month would be currentMonth.prevMonth()
            updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
            alert("The new month is "+currentMonth.month+" "+currentMonth.year);
        }, false);

        // Change the month when the "prev" button is pressed
        document.getElementById("prev-month-btn").addEventListener("click", function(event){
            currentMonth = currentMonth.prevMonth(); // Previous month would be currentMonth.prevMonth()
            updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
            alert("The new month is "+currentMonth.month+" "+currentMonth.year);
        }, false);

       
        // This updateCalendar() function only alerts the dates in the currently specified month.  You need to write
        // it to modify the DOM (optionally using jQuery) to display the days and weeks in the current month.

        function updateCalendar(){
            document.getElementById("month").textContent=currentMonth.month;

            document.getElementById("year").textContent=currentMonth.year;
            let weeks = currentMonth.getWeeks();
            
            for(let w in weeks){
                let days = weeks[w].getDates();
                // days contains normal JavaScript Date objects.
               // alert("Week starting on "+days[0]);
                for(let d in days){
                    document.getElementsByClassName("week")[w].children[d].textContent=days[d].getDate();
                    
                }
            }
        }

    </script>
</body>
</html>